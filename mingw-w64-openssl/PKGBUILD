# Maintainer: Alexey Pavlov <Alexpux@gmail.com>

_realname=openssl
pkgbase=mingw-w64-${_realname}
pkgname=("${MINGW_PACKAGE_PREFIX}-${_realname}"
	"${MINGW_PACKAGE_PREFIX}-${_realname}-pdb")
pkgver=3.5.4
pkgrel=1
pkgdesc="The Open Source toolkit for Secure Sockets Layer and Transport Layer Security (mingw-w64)"
arch=('any')
mingw_arch=('mingw32' 'mingw64' 'ucrt64' 'clang64' 'clang32' 'clangarm64')
url='https://www.openssl.org/'
license=("spdx:Apache-2.0")
optdepends=("${MINGW_PACKAGE_PREFIX}-ca-certificates")
makedepends=("${MINGW_PACKAGE_PREFIX}-cc"
             "${MINGW_PACKAGE_PREFIX}-autotools")
if [[ "$MSYSTEM" != CLANG* ]]; then
  makedepends+=("${MINGW_PACKAGE_PREFIX}-cv2pdb")
fi
options=('!strip' '!buildflags')
source=("https://github.com/openssl/openssl/releases/download/openssl-${pkgver}/openssl-${pkgver}.tar.gz"{,.asc}
        '0001-support-aarch64.patch'
        '0002-relocation.patch'
        '0003-test_rand-use-the-better-chomp.patch'
        '0004-mingw32-broken-test.patch'
        '0005-Fix-Text-comparison.patch'
        '0006-Mangle-Absolute-path.patch'
        '0007-Fix-OS-detection.patch'
        'pathtools.c'
        'pathtools.h')
sha256sums=('967311f84955316969bdb1d8d4b983718ef42338639c621ec4c34fddef355e99'
            'SKIP'
            'baaaab0e91caf5690d4a264146cff2030bb5852ad14712d7f89e7e072533ae11'
            'a45ab8e18db920e8c559d80598664cfb52d2f4e09653f4caaa0f4de0055982cf'
            'c41bc19de1448b08b61ee47b55620e7629e9189a9a7f4e2fac42e8a9e5823d30'
            '0862c9751775f1c75d0495538951343ff83c83a5344e61e091dd3e964a630640'
            '52a4c65eb0af1a8319e2ece6e714ae6130f27bd46ba8d40966428694d64728ed'
            'eca965cb6761cfa294857fd85eef4aa27fdc7e322ebcd88a1b67c4c668be7121'
            'a00fe4dbc0c5848ccb1b205e3aae2dccd5246745e517e74349dfdb3b25968047'
            '08209cbf1633fa92eae7e5d28f95f8df9d6184cc20fa878c99aec4709bb257fd'
            '965d3921ec4fdeec94a2718bc2c85ce5e1a00ea0e499330a554074a7ae15dfc6')

# https://www.openssl.org/community/otc.html
validpgpkeys=(
  '8657ABB260F056B1E5190839D9C4D26D0E604491' # Matt Caswell <matt@openssl.org>
  '7953AC1FBC3DC8B3B292393ED5E9E43F7DF9EE8C' # Richard Levitte <richard@levitte.org>
  'A21FAB74B0088AA361152586B8EF1A6BA9DA2D5C' # Tomáš Mráz <tm@t8m.info>
  'B7C1C14360F353A36862E4D5231C84CDDCC69C45' # Paul Dale <pauli@openssl.org>
  'EFC0A467D613CB83C7ED6D30D894E2CE8B3D79F5' # OpenSSL Management Committee <openssl-omc@openssl.org>
  'BA5473A2B0587B07FB27CF2D216094DFD0CB81EF' # OpenSSL <openssl@openssl.org>
)

# Helper macros to help make tasks easier #
apply_patch_with_msg() {
  for _patch in "$@"
  do
    msg2 "Applying $_patch"
    patch -Nbp1 -i "${srcdir}/$_patch"
  done
}
# =========================================== #

prepare() {
  cd ${srcdir}/${_realname}-${pkgver}

  apply_patch_with_msg \
     0001-support-aarch64.patch \
     0002-relocation.patch \
     0003-test_rand-use-the-better-chomp.patch \
     0005-Fix-Text-comparison.patch \
     0006-Mangle-Absolute-path.patch \
     0007-Fix-OS-detection.patch

  if [[ "$MSYSTEM" == MINGW32 ]]
  then
    # MINGW32 gmtime() doesn't handle negative values particularly well, which breaks a test that expects a
    # negative value after converting an invalid ASN1 string to time_t but can't compare the expected result
    # with the actual result
    apply_patch_with_msg 0004-mingw32-broken-test.patch
  fi

  test ! -d "${startdir}/../mingw-w64-pathtools" || {
    cmp "${startdir}/../mingw-w64-pathtools/pathtools.c" "${srcdir}/pathtools.c" &&
    cmp "${startdir}/../mingw-w64-pathtools/pathtools.h" "${srcdir}/pathtools.h"
  } || exit 1

  cp -fHv "${srcdir}"/pathtools.c crypto/
  cp -fHv "${srcdir}"/pathtools.h ./
}

build() {
  mkdir -p "${srcdir}/build-${MSYSTEM}" && cd "${srcdir}/build-${MSYSTEM}"

  # Use mingw cflags instead of hardcoded ones
  sed -i -e '/^"mingw"/ s/-fomit-frame-pointer -O3 -Wall/-O2 -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions --param=ssp-buffer-size=4/' \
    ${srcdir}/${_realname}-${pkgver}/Configurations/10-main.conf

  case "${CARCH}" in
    i?86)
      _mingw=mingw
      ;;
    x86_64)
      _mingw=mingw64
      ;;
    aarch64)
      _mingw=mingwarm64
      ;;
  esac

  STRIP_OPTS=

  if [[ "$MSYSTEM" == CLANG* ]]
  then
    export LDFLAGS="-Wl,-pdb=" # Ensures that Clang generates PDB files
    STRIP=llvm-strip
    STRIP_OPTS=--strip-debug
  else
    STRIP=cv2pdb
  fi
  MSYS2_ARG_CONV_EXCL="--prefix=" \
  ../"${_realname}-${pkgver}"/Configure \
    --prefix="${MINGW_PREFIX}" \
    --libdir=lib \
    --openssldir=etc/ssl \
    ${_mingw} \
    shared \
    zlib-dynamic \
    enable-camellia \
    enable-capieng \
    enable-idea \
    enable-mdc2 \
    enable-rc5  \
    enable-rfc3779 \
    -DOPENSSLBIN=\"\\\"${MINGW_PREFIX}/bin\\\"\"

  MSYS2_ARG_CONV_EXCL="-DENGINESDIR=;-DMODULESDIR=;-DOPENSSLDIR=;-DINSTALLTOP=;-DOPENSSLBIN=" \
  make

  case "${pkgname[@]}" in
  *-pdb|*-pdb\ *)
    for file in apps/*.exe *.dll engines/*.dll
    do
      $STRIP $STRIP_OPTS "$file" || exit
    done

    # copy cv2pdb'ed versions of libeay32.dll and ssleay32.dll to apps/
    cp -f *.dll *.pdb apps/;;
  esac
}

check() {
  cd "${srcdir}/build-${MSYSTEM}"

  make VERBOSE_FAILURE=1 TESTS=-test_symbol_presence test
}

_package() {
  cd "${srcdir}/build-${MSYSTEM}"

  test pdb != "$1" || {
    install -d -m 755 "${pkgdir}${MINGW_PREFIX}/bin"
    install -d -m 755 "${pkgdir}${MINGW_PREFIX}/lib/engines"
    install -m 755 *.pdb "${pkgdir}${MINGW_PREFIX}/bin"
    install -m 755 apps/openssl.pdb "${pkgdir}${MINGW_PREFIX}/bin"
    install -m 755 engines/*.pdb "${pkgdir}${MINGW_PREFIX}/lib/engines"
    return
  }

  make install DESTDIR="${pkgdir}"

  install -Dm644 "${srcdir}/${_realname}-${pkgver}/LICENSE.txt" "${pkgdir}${MINGW_PREFIX}/share/licenses/${_realname}/LICENSE"
}

package_mingw-w64-i686-openssl() {
  _package
}

package_mingw-w64-x86_64-openssl() {
  _package
}

package_mingw-w64-clang-aarch64-openssl() {
  _package
}

package_mingw-w64-i686-openssl-pdb() {
  _package pdb
}

package_mingw-w64-x86_64-openssl-pdb() {
  _package pdb
}

package_mingw-w64-clang-aarch64-openssl-pdb() {
  _package pdb
}
